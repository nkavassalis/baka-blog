<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>baka-blog</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
  <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
  <style>
    body { display: flex; height: 100vh; margin: 0; font-family: sans-serif; background: #1e1e1e; color: #ddd; }
    #main { flex: 1; display: flex; flex-direction: column; }
    #editor { flex: 1; }
    #actions { padding: 10px; background: #2d2d2d; }
    #preview { flex: 1; overflow-y: auto; padding: 10px; background: #1a1a1a; border-top: 1px solid #333; }
    #sidebar { width: 300px; flex: 0 0 300px; background: #2d2d2d; display: flex; flex-direction: column; }
    #postContainer { flex: 2; overflow-y: auto; padding: 10px; }
    #messages { flex: 1; overflow-y: auto; background: #111; color: #ddd; font-family: monospace; padding: 5px; border-top: 1px solid #333; }
    #preview img { max-width: 100%; height: auto; display: block; margin: 0 auto; }
    button { margin: 5px 0; padding: 6px 10px; background: #444; color: #fff; border: none; cursor: pointer; }
    button:hover { background: #666; }
    li { margin: 5px 0; cursor: pointer; }
    li:hover { text-decoration: underline; }
    .inline { display: inline-block; margin-right: 10px; }
    label { font-size: 0.9em; margin-left: 5px; }
    .stdout { color: #0f0; }
    .stderr { color: #f55; }
    .status { color: #ff0; }
    #imagePanel { display: none; background: #222; padding: 10px; border-top: 1px solid #333; overflow-y: auto; max-height: 250px; }
    .thumb { display: inline-block; margin: 5px; text-align: center; }
    .thumb img { max-width: 100px; max-height: 100px; display: block; margin-bottom: 5px; }
    .thumb button { background: #a33; }
    .thumb button:hover { background: #c55; }
  </style>
</head>
<body>
  <div id="sidebar">
    <div id="postContainer">
      <button onclick="newPost()">+ New Post</button>
      <ul id="postList"></ul>
    </div>
    <div id="messages"></div>
  </div>
  <div id="main">
    <textarea id="editor"></textarea>
    <div id="actions">
      <input type="file" id="imageUpload" class="inline">
      <input type="checkbox" id="insertAtEnd" class="inline" checked>
      <label for="insertAtEnd">Insert images at end</label>
      <br>
      <button onclick="savePost()">Save</button>
      <button onclick="deletePost()">Delete</button>
      <button onclick="regenerate()">Regenerate Site</button>
      <button onclick="clearLogs()">Clear Logs</button>
      <button onclick="toggleImages()">Manage Images</button>
    </div>
    <div id="preview"></div>
    <div id="imagePanel"></div>
  </div>

<script>
let currentFile = null
let currentSlug = null
let imagePanelVisible = false

const editor = new SimpleMDE({
  element: document.getElementById("editor"),
  renderingConfig: { singleLineBreaks: false }
})
editor.codemirror.setOption("theme", "dracula")

function logMessage(msg, type="status") {
  const box = document.getElementById("messages")
  const div = document.createElement("div")
  div.className = type
  div.innerHTML = msg.replace(/\n/g, "<br>")
  box.appendChild(div)
  box.scrollTop = box.scrollHeight
}

function clearLogs() {
  document.getElementById("messages").innerHTML = ""
}

function loadPosts() {
  fetch("/api/posts").then(r => r.json()).then(posts => {
    const ul = document.getElementById("postList")
    ul.innerHTML = ""
    posts.forEach(p => {
      const li = document.createElement("li")
      li.textContent = p.title + (p.date ? " (" + p.date + ")" : "")
      li.onclick = () => loadPost(p.filename, p.slug)
      ul.appendChild(li)
    })
  })
}

function loadPost(filename, slug) {
  fetch("/api/post/" + filename).then(r => r.json()).then(data => {
    currentFile = filename
    currentSlug = slug
    editor.value(data.content)
    updatePreview()
    logMessage("Loaded " + filename, "status")
    hideImages()
  })
}

function savePost() {
  if (!currentFile) { logMessage("No post loaded.", "stderr"); return }
  fetch("/api/post/" + currentFile, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ content: editor.value() })
  }).then(() => { logMessage("Saved " + currentFile, "status"); loadPosts() })
}

function deletePost() {
  if (!currentFile) { logMessage("No post loaded.", "stderr"); return }
  if (!confirm("Delete this post?")) return
  fetch("/api/delete/" + currentFile, { method: "DELETE" })
    .then(() => { 
      logMessage("Deleted " + currentFile, "status")
      currentFile = null
      currentSlug = null
      editor.value("")
      loadPosts()
      hideImages()
    })
}

function newPost() {
  const title = prompt("Enter post title:")
  if (!title) return
  fetch("/api/new", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ title })
  }).then(r => r.json()).then(res => {
    currentFile = res.filename
    currentSlug = res.slug
    loadPosts()
    loadPost(currentFile, currentSlug)
    logMessage("Created new post " + res.filename, "status")
  })
}

document.getElementById("imageUpload").addEventListener("change", function() {
  if (!currentSlug) { logMessage("No post loaded.", "stderr"); return }
  const formData = new FormData()
  formData.append("file", this.files[0])
  fetch("/api/upload_image/" + currentSlug, { method: "POST", body: formData })
    .then(r => r.json()).then(res => {
      const markdown = `![${res.filename}](${res.path})`
      const cm = editor.codemirror
      if (document.getElementById("insertAtEnd").checked) {
        cm.setCursor(cm.lineCount(), 0)
        cm.replaceSelection("\n" + markdown + "\n")
      } else {
        cm.replaceSelection(markdown)
      }
      updatePreview()
      logMessage("Uploaded " + res.filename, "status")
      if (imagePanelVisible) loadImages()
    })
})

function toggleImages() {
  if (imagePanelVisible) {
    hideImages()
  } else {
    loadImages()
  }
}

function hideImages() {
  document.getElementById("imagePanel").style.display = "none"
  document.getElementById("imagePanel").innerHTML = ""
  imagePanelVisible = false
}

function loadImages() {
  if (!currentSlug) return
  fetch("/api/images/" + currentSlug).then(r => r.json()).then(images => {
    const panel = document.getElementById("imagePanel")
    panel.innerHTML = ""
    if (images.length === 0) {
      panel.innerHTML = "<p>No images uploaded for this post.</p>"
    } else {
      images.forEach(img => {
        const div = document.createElement("div")
        div.className = "thumb"
        const image = document.createElement("img")
        image.src = img.url
        const btn = document.createElement("button")
        btn.textContent = "Delete"
        btn.onclick = () => {
          if (!confirm("Delete this image?")) return
          fetch("/api/delete_image/" + currentSlug + "/" + img.filename, { method: "DELETE" })
            .then(() => { logMessage("Deleted " + img.filename, "status"); loadImages() })
        }
        div.appendChild(image)
        div.appendChild(document.createTextNode(img.filename))
        div.appendChild(btn)
        panel.appendChild(div)
      })
    }
    panel.style.display = "block"
    imagePanelVisible = true
  })
}

function updatePreview() {
  let content = editor.value()
  if (content.startsWith("---")) {
    const parts = content.split("---")
    if (parts.length >= 3) content = parts.slice(2).join("---")
  }
  document.getElementById("preview").innerHTML = editor.options.previewRender(content)
}

editor.codemirror.on("change", updatePreview)

function regenerate() {
  logMessage("Regenerating site...", "status")
  fetch("/api/regenerate", { method: "POST" })
    .then(r => r.json()).then(res => {
      if (res.stdout) logMessage("STDOUT:\n" + res.stdout, "stdout")
      if (res.stderr) logMessage("STDERR:\n" + res.stderr, "stderr")
      logMessage("Done (exit code " + res.returncode + ")", "status")
    }).catch(err => logMessage("Error: " + err, "stderr"))
}

loadPosts()
</script>
</body>
</html>

